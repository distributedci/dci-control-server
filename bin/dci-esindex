#!/usr/bin/env python
# -*- coding: utf-8 -*-
#
# Copyright (C) 2015 Red Hat, Inc
#
# Licensed under the Apache License, Version 2.0 (the "License"); you may
# not use this file except in compliance with the License. You may obtain
# a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations
# under the License.

from dci import dci_config
import dci.elasticsearch.engine
from dciclient.v1.api import context
import dciclient.v1.api.file as dci_file
import json
import sys

def main():
    dci_context = context.build_dci_context()
    conf = dci_config.generate_conf()

    es_engine = dci.elasticsearch.engine.DCIESEngine(conf,timeout=60)
    for es_file in es_engine.iter():
         print('S')
         if dci_file.get(dci_context, es_file['_id']).status_code == 404:
             print('d')
             es_engine.delete(es_file['_id'])

    # Prepare the to add list
    for db_file in dci_file.iter(dci_context):
        print('D')
        if not es_engine.get(db_file['id'], _source_include=['_id']):
            db_file['content'] = dci_file.content(dci_context, db_file['id']).content.decode('UTF-8')
            print('A')
            es_engine.index(db_file)


if __name__ == '__main__':
    main()
